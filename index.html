<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
    <script type="text/javascript" src="http://mbostock.github.com/d3/d3.js?1.29.1"></script>
    <style type="text/css">
      html, body, #map {
        width: 500px;
        height: 500px;
        margin: 0;
        padding: 0;
      }

      svg:line {
        outline: none;
        border-color: #9ecaed;
        box-shadow: 0 0 10px #9ecaed;
      }


      .stations, .stations svg {
        position: absolute;
      }

      .stations svg {
        width: 60px;
        height: 20px;
        padding-right: 100px;
        font: 10px sans-serif;
      }

      .stations circle {
        fill: brown;
        stroke: black;
        stroke-width: 1.5px;
      }

    </style>
  </head>
  <body>
    <div id="map"></div>
    <script src="./Path demonstration_files/pathlayout.js"></script>
    <script type="text/javascript">

      var map = new google.maps.Map(d3.select("#map").node(), {
        zoom:3,
        center: new google.maps.LatLng(21.401817, 39.839680),
        mapTypeId: google.maps.MapTypeId.TERRAIN
      });

      var overlay = new google.maps.OverlayView();

      overlay.onAdd = function(){
          
          var stationsLayer = d3.select(this.getPanes().overlayLayer).append("div")
              .attr("class", "stations");

          var layer = d3.select(this.getPanes().overlayLayer).append("svg")
              .attr("id", "main")
              .attr("width",500)
              .attr("height",500);

          overlay.draw = function() {


            var projection = this.getProjection(),
                padding = 10;

            records_data = []

            d3.csv("vis_data_path.csv", function(records, error) {

                var iterator = 0

                records = records.slice(0,200);

                // record = records[152];

                records.forEach(function(record){

                  iterator = iterator + 1;

                  loc = record['location'];
                  time = record['loc_time']
                  route = record['path']
                  ind = record['ind']
                  screen_name = record['screen_name']

                  if(route != ''){

                      //check if the source and destination are same  
                      route = JSON.parse(route.replace(/'/g, '"'))

                      route.forEach(function(line, i){
                        records_data.push({'x':line['y1'], 'y':line['x1'], 'i':i});
                      });

                      layout = d3.layout.trail() 

                      function transform(d) {
                        d = new google.maps.LatLng(d["x"], d["y"]);
                        d = projection.fromLatLngToDivPixel(d);
                        return [d.x, d.y];
                      }

                      layout = layout 
                          .positioner(transform)
                          .coordType("xy");//function(d) {return [x(d['x']),y(d['y'])]}

                      var out = layout.data(records_data).layout()

                      var line = d3.select("#main").selectAll("line").data(out)

                      line
                        .enter()
                        .append("line")
                        .style("stroke-width",10)
                        .style("stroke","orange")
                        .style("opacity",10) 
                        .attr("x0",function(d) {return d['x0']})
                        .attr("x1",function(d) {return d.x1}) 
                        .attr("y1",function(d) {return d.y1}) 
                        .attr("y2",function(d) {return d.y1}) 
                        .attr("x2",function(d) {return d.x1})
                        .transition() 
                        // .delay(function(d,i)   {return i*100})               
                        .attr("y2",function(d, i) {return d.y2}) 
                        .attr("x2",function(d, i) {return d.x2})
                        .transition()
                        // .duration(1000)
                        .style("opacity",0.2)
                        // .remove()

                  }
                  else{

                      console.log('Within else');

                      loc = JSON.parse(loc);
                      arr = [{'x':loc[0], 'y':loc[1]}];
                      
                      new_arr = []
                      arr = arr.forEach(function(d) {
                        // d = new google.maps.LatLng(d.value[1], d.value[0]);
                        // console.log(d);
                        d = new google.maps.LatLng(d['x'], d['y']);
                        d = projection.fromLatLngToDivPixel(d);
                        // console.log(d);  
                        new_arr.push(d);
                      });

                      var marker = stationsLayer.selectAll("svg")
                          .data(new_arr)
                        .enter().append("svg:svg")
                            .style("left", function(d){ console.log(d.x);(d.x - padding) + "px"})
                            .style("top", function(d){console.log(d.y); (d.y - padding) + "px"})
                          .attr("class", "marker");
;

                      // Add a circle.
                      marker.append("svg:circle")
                          .attr("r", 4.5)
                          .attr("cx", padding)
                          .attr("cy", padding);


                      

                    }
                });
            });


          };
      };

        

        // Bind our overlay to the mapâ€¦
      overlay.setMap(map);
      // });

    </script>
  </body>
</html>